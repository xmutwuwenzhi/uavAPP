# uavAPP
uavAPP
项目功能：
1、无人机通过获取IPv6的IP，获得唯一的ID；
2、无人机通过无线连接至地面站，通过地面站进行路径规划；
3、无人机通过地面站之间进行交互，通过地面站进行通信。

测试环境：
	安卓手机一部，Android 2.0系统以上。
	IPv6网络环境

功能列表：
本程序采用四旋翼无人机作为程序载体，通过外挂GPS传感器，陀螺仪等外置辅助装置，对无人机进行导航控制，使其能够平稳地按照既定航线进行巡航。其核心控制算法为PID控制算法，PID控制为经典控制算法，是无人机控制的主流算法之一，本程序采用PID作为基本控制算法。
程序首先对外界GPS、陀螺仪等信息进行预采集，并进行纠偏。其次对无人机信息进行读取，并进行滤波操作。最后采用PID控制对无人机的旋翼进行控制，进而实现无人机平稳巡航。
软件工作流程：
软件核心算法是PID算法，P为比例调节，D为微分调节，I为积分调节。由于计算机控制是一种采样控制，它根据时间周期时刻的偏差来计算控制量来减少误差，当偏差为0时，控制量也为0。P为比例调节，能够对误差信息进行放大，进而使控制效果更好，但是倘若P值过大，则容易形成超调。
I为积分调节，即将误差信息进行累加，能够对结果的误差进行累加，对系统的稳定性有一定的帮助。
D为微分调节，主要对系统变化率进行调节，由于系统中的误差变化率进行修改，对系统快速性有一定的作用。
对于离散的PID表达式为：
u_k=K_p e_k+K_i ∑_i^k▒〖e_j+K_d (e_k-e_(k-1))〗
其中，u_k为控制量，K_p 〖，K〗_i 〖，K〗_d分别为PID控制器的三个参数。
首先系统读取外部传感器信息，将控制量信息输入飞行控制系统，输出控制信息，对比实际信息反馈回飞行控制系统，形成负反馈。
 
整个飞行控制系统流程图，整个程序由两个PID循环控制构成，内环为姿态PID控制，外环为高度PID控制。内环PID首先通过读取Kp,Ki,Kd的参数信息，计算当前内环的姿态误差，通过累加计算内环PID计算出内环的控制量，控制内环姿态数据。而外环PID控制为高度控制，通过读取实际高度信息，和目标高度值，计算出高度误差，读取外环PID控制值，计算出控制内环姿态数据值，进而输出舵面控制值。
 
无人机飞行轨迹结果如图3所示，通过计算无人机的路径信息，规划出无人机飞行最短轨迹，进而形成最终飞行轨迹，其结果如下图所示，其中左下角为起飞位置，右上角为目标位置，中间设置了多个路径障碍。

 其在地面站运行部分路径结果如下图所示：
导游飞行器地面站软件总体设计中，导游飞行器地面站软件主要包括用户接口模块、路径规划模块、无人机视频信息模块、无人机遥测接收模块和无线模块。用户通过用户接口模块将导航信息输入地面站，路径规划模块读取用户当前位置及目标位置，进行最短路径规划，并通过无线模块发送至导游飞行器，导游飞行器根据所规划的路径对用户进行飞行导游，并实时将视频信息及姿态信息回显至用户接口模块中，并在显示器中进行显示。

为了确保导游无人机在互联网缺失的情况下依然能够使用，导游飞行器地面站软件首先通过加载Google离线地图到本地，通过对路口位置信息进行编码，形成本地的查询表，并加上路径加权值，为路径规划模块的快速使用提供条件。每次进行路径规划，产生最佳路径后，将当前路径插入最优路径数据库中。下次进行相同位置路径规划，则优先查找最优路径数据库。 
	地面站软件详细设计
导游飞行器地面站软件流程中，用户首先输入目的地信息，系统判断是否合法，并进行路径规划，路径规划后得到用户到达目的地的最佳路径。并将其离散化为控制量，通过无线模块发送至无人机，无人机中飞行控制计算机通过PID算法进行导航。无人机接收到控制信息后，通过内置飞行控制计算机进行飞行，并将姿态信息和视频信息通过遥测模块回显至地面站。本小结地面站软件详细设计主要包括地面站软件界面设计和路径规划设计。

	地面站软件界面设计
鉴于该系统的任务流程设计，本设计将界面设计分为如下四个组成结构：用户选择界面，导游地图显示界面，遥测数据显示界面，无人机视频显示界面。
（1）用户选择界面：地面站对接用户的重要接口，用户输入为用户提供数据输入功能。首先由用户对目的地址进行选择，而当前位置由GPS进行获取，通过这两个位置信息的获取，通过最优路径算法对路径进行筛选，从而得到最佳导游路径。
（2）导游地图显示界面：通过手持终端对Google离线地图进行载入，通过获取当前位置信息，及用户输入信息，查找数据库，获取其地图上的像素点位置，结合路径规划信息，通过OpenGL函数库对无人机进行建模美化，对导游地图进行动态显示。
（3）遥测数据显示界面：遥测数据接收模块负责地面站与无人机之间的通信。首先，在无人机系统中起一个web服务，并采用Socket编程与地面站进行通讯。地面站通过Wifi无线连接导游无人机，并启用相应UDP端口进行数据接收、进行渲染并显示。显示的数据包括飞行时间、飞行姿态、飞行速度、已飞行距离及待飞行距离。
（4）视频显示界面界面：通过接收导游飞行器的视频数据，通过OpenGL进行建模，将遥测数据及无人机视角视频进行显示。同时，将无人机飞行方向通过语音对用户进行播放提醒，提升用户的体验感。
	路径规划设计
路径规划设计是整个导游地面站的核心模块，是导游无人机系统的中心，合理的路径规划能够为用户提供优秀的导游体验。路径规划设计结构路径规划流程由路径规划预处理、路径规划计算和路径规划输出构成。
 
3.2.1 路径规划预处理
路径规划预处理主要建立离线地图数据离散化数据库，进而为路径计算提供数据库服务，通过不断更新维护数据库，为路径规划计算提供依据。路径规划预处理首先载入Google离线地图，对各个楼宇及路口进行位置计算，并根据道路进行编码。本设计采用三部分进行编码，即横向道路编码，竖向道路编码和位置编码，通过三个编码即可确定特定位置。同时，载入位置的经纬度及图像的像素点位置信息插入到数据库中，同时，更新当前位置与上一个路口和下一个路口的权重，数据库数据格式如表1所示。
表1 导游数据库数据格式表
横向道 路	纵向道 路	位置	名称	图像
位置X	图像
位置Y	经度	纬度	权重
6	4	21	北门	1167	164	11 849.610 24	3 202.707 51	[8 0 14 7 4 0]
4	3	12	综合楼	830	1267	11 849.604 26	3 202.471 80	[ 9 16 5 8 4 2]
6	0	2	图书馆	1090	2476	11 849.429 62	3 202.394 54	[14 0 0 4 3 3]
在表1中，给出了部分学校位置的数据库数据。通过对学校各位置信息进行编码，以横向道路编号纵向道路编号及位置编码进行编码，如北门编码在第5横向道路与第4纵向道路上，并且在第21的编号位置上。需要到达北门需先往第5横向道路或者第4纵向道路方向导航。图像位置X与图像位置Y分别为离线地图上的图像像素点位置，通过程序在地图上获取得到确切数据，并填入上表。经纬度信息为实时读取飞行器的GPS模块，并获取得到经纬度信息。
权重信息为一个1*6矩阵A = [8 0 14 7 4 0]，矩阵A的数值元素分别表示：当前信息距离上个横向道路、下个横向道路、上个纵向道路、下个纵向道路、上个位置和下个位置距离权重。其中，权重为0表示无此位置信息。比如北门权重信息代表距离横向道路为5的距离权重为8；距离横向道路距离为7的距离权重为0， 即无横向道路7；北门距离纵向道路为3的距离权重为14；距离纵向道路为5的距离权重为7；北门距离位置信息为20的距离权重为4，而没有位置信息22。权重信息首先通过图像位置计算而得，后期随着导游数据的增加不断更新权重信息。
3.2.2 路径规划计算
路径规划计算模块是导游无人机路径规划的核心，路径规划通过源位置及目的位置查找一条最短的路径，根据路径信息修改道路权重信息，更新至最优路径数据库中。其程序流程如下所示：
	路径规划模块首先通过遥测数据获取无人机的位置信息，同时，根据用户输入模块得到目的地信息，通过导游数据库查询得到初始位置及目的位置的所有编码信息。
	根据初始位置及目的位置的编码信息依次进行组合路径，并通过计算每一条路径的权重，得出所有导游路线的路线总权重，然后通过比较各个路线的总权重得出最佳路径。
	根据得出的最佳路径，更新导游数据库数据，将降低最佳路径的总路径权重，进而后期快速得出最佳路径。并将最优路径信息输入导游数据库，进而得到最优路径数据库。
	最优路径数据库生成后，路径规划计算首先查找最优路径数据库，倘若数据存在，则使用数据库中数据；倘若数据库中数据不存在，重复（1）-（3）步骤，获取最佳路径，并更新最优路径数据库。
通过不断更新及优化最优路径数据库，路径规划计算模块处理数据速度将不断提升，并同时为路径规划输出至地图提供服务。最优路径数据库里的元素为N*6的矩阵，其结构如表2所示。在表2中，显示一条从北门到经管院的最优路径数据，其数据格式为4*6的矩阵B，B的每一行元素表示一个经过位置的编码信息，每个行向量包括6个信息分别为横向道路编码、纵向道路编码、位置信息、位置名称及图像位置X与图像位置Y。通过将其位置X与位置Y结合OpenGL将路径在离线地图上绘画出来。
表2 最优路径数据库数据格式表
横向
道 路	纵向
道 路	位置	名称	图像
位置X	图像
位置Y
5	4	21	北门	1167	164
5	0	0	路口4	870	2721
3	0	0	路口2	458	2699
3	2	8	机电学院	621	1423

3.2.3 路径规划输出
由3.2.2得出用户到达目的地的最优路径，每个最优路径由多个小路线组成，因此控制信号也相应的由多个离散的数据组成。将数据库中的经纬度信息取出，形成一个N*2的矩阵，通过将经纬度信息依次取出发送至导游无人机中，通过位置PID算法进行闭环控制，实现无人机沿着既定路径进行飞行。
同时，导游无人机将遥测数据下发至地面站，地面站根据遥测数据，将导游无人机飞行轨迹通过音频播出，并将无人机视角视频信息实时显示至地面站。

